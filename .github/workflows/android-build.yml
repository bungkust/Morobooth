name: Android APK Build

on:
  workflow_dispatch:
    inputs:
      buildType:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options: [debug, release]
      webviewUrl:
        description: 'WebView URL (optional, default from app.json)'
        required: false
        default: 'https://morobooth.netlify.app'
        type: string

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'apps/mobile/package-lock.json'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Get version info
        id: version
        working-directory: ./apps/mobile
        run: |
          VERSION=$(node -p "require('./app.json').expo.version")
          BUILD_DATE=$(date +'%Y%m%d')
          BUILD_TIME=$(date +'%H%M%S')
          APK_NAME="morobooth-v${VERSION}-${{ inputs.buildType }}-${BUILD_DATE}-${BUILD_TIME}"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "APK_NAME=$APK_NAME" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "APK Name: $APK_NAME"

      - name: Install dependencies
        working-directory: ./apps/mobile
        run: npm ci

      - name: Verify and update app.json configuration
        working-directory: ./apps/mobile
        run: |
          echo "Checking app.json configuration..."
          node -e "const config = require('./app.json'); console.log('Webview URL (before):', config.expo.extra?.webviewUrl || 'NOT SET'); console.log('Version:', config.expo.version);"
          
          echo "================================================"
          echo "Updating app.json with webviewUrl"
          echo "================================================"
          
          # Update app.json with environment variable (matching EAS build behavior)
          export WEBVIEW_URL="${{ inputs.webviewUrl || 'https://morobooth.netlify.app' }}"
          
          node -e "
            const fs = require('fs');
            const config = require('./app.json');
            
            if (!config.expo.extra) {
              config.expo.extra = {};
            }
            
            config.expo.extra.webviewUrl = process.env.WEBVIEW_URL;
            
            fs.writeFileSync('./app.json', JSON.stringify(config, null, 2));
            console.log('âœ… Webview URL updated to:', config.expo.extra.webviewUrl);
          "
          
          # Verify the update
          echo ""
          echo "Verification:"
          node -e "const config = require('./app.json'); console.log('  app.json now contains webviewUrl:', config.expo.extra.webviewUrl);"
          echo "================================================"

      - name: Prebuild Android
        working-directory: ./apps/mobile
        env:
          EXPO_PUBLIC_WEBVIEW_URL: ${{ inputs.webviewUrl || 'https://morobooth.netlify.app' }}
        run: |
          npx expo prebuild --platform android --clean
          
      - name: Ensure assets directory exists
        working-directory: ./apps/mobile
        run: |
          mkdir -p android/app/src/main/assets
          echo "Assets directory ready for bundle"

      - name: Prepare keystore (release only)
        if: ${{ inputs.buildType == 'release' }}
        working-directory: ./apps/mobile/android
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "================================================"
          echo "Preparing Release Keystore"
          echo "================================================"
          
          # Decode and save keystore
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > app/release.keystore
          
          # Verify keystore was created
          if [ -f "app/release.keystore" ]; then
            KEYSTORE_SIZE=$(ls -lh app/release.keystore | awk '{print $5}')
            echo "âœ… Keystore created successfully"
            echo "   Location: $(pwd)/app/release.keystore"
            echo "   Size: $KEYSTORE_SIZE"
          else
            echo "âŒ Keystore creation failed!"
            exit 1
          fi
          
          echo "================================================"

      - name: Verify app.json before build
        working-directory: ./apps/mobile
        run: |
          echo "Final app.json verification before build:"
          node -e "
            const config = require('./app.json');
            console.log('App Name:', config.expo.name);
            console.log('Version:', config.expo.version);
            console.log('Package:', config.expo.android.package);
            console.log('WebView URL:', config.expo.extra.webviewUrl);
            console.log('EAS Project ID:', config.expo.extra.eas.projectId);
          "

      - name: Build APK with Gradle
        working-directory: ./apps/mobile/android
        env:
          EXPO_PUBLIC_WEBVIEW_URL: ${{ inputs.webviewUrl || 'https://morobooth.netlify.app' }}
          NODE_ENV: "production"
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_ALIAS_PASSWORD: ${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}
        run: |
          chmod +x gradlew
          
          echo "================================================"
          echo "Building APK - Configuration Summary"
          echo "================================================"
          echo "Build Type: ${{ inputs.buildType }}"
          echo "WebView URL: $EXPO_PUBLIC_WEBVIEW_URL"
          echo "Bundle Command: export:embed (from build.gradle)"
          echo "Node Version: $(node --version)"
          echo "================================================"
          
          # Build APK with proper configuration
          # The bundleCommand = "export:embed" in build.gradle will:
          # 1. Run npx expo export:embed
          # 2. Bundle JavaScript and assets
          # 3. Embed into android/app/src/main/assets/
          # 4. Make Constants.expoConfig available with app.json values
          
          if [ "${{ inputs.buildType }}" = "release" ]; then
            echo "ðŸ”¨ Building Release APK..."
            
            # Use absolute path for keystore to avoid path resolution issues
            KEYSTORE_PATH="$(pwd)/app/release.keystore"
            
            # Verify keystore exists before building
            if [ ! -f "$KEYSTORE_PATH" ]; then
              echo "âŒ ERROR: Keystore not found at $KEYSTORE_PATH"
              echo "Available files in app/:"
              ls -la app/ | grep -E "keystore|\.jks"
              exit 1
            fi
            
            echo "ðŸ“ Keystore path: $KEYSTORE_PATH"
            echo ""
            
            ./gradlew assembleRelease \
              -Pandroid.injected.signing.store.file="$KEYSTORE_PATH" \
              -Pandroid.injected.signing.store.password="$ANDROID_KEYSTORE_PASSWORD" \
              -Pandroid.injected.signing.key.alias="$ANDROID_KEY_ALIAS" \
              -Pandroid.injected.signing.key.password="$ANDROID_KEY_ALIAS_PASSWORD" \
              --info
          else
            echo "ðŸ”¨ Building Debug APK..."
            ./gradlew assembleDebug --info
          fi
          
          echo "================================================"
          echo "Verifying Build Output"
          echo "================================================"
          
          # Verify JavaScript bundle was created
          if [ -f "app/src/main/assets/index.android.bundle" ]; then
            echo "âœ… JavaScript bundle created successfully"
            BUNDLE_SIZE=$(ls -lh app/src/main/assets/index.android.bundle | awk '{print $5}')
            echo "   Bundle size: $BUNDLE_SIZE"
            echo "   Bundle contains app.json configuration with webviewUrl"
          else
            echo "âš ï¸ JavaScript bundle not found"
            echo "This might cause the app to not work properly!"
          fi
          
          # List all assets
          if [ -d "app/src/main/assets" ]; then
            echo ""
            echo "Assets directory contents:"
            ls -lh app/src/main/assets/
          fi
          
          echo "================================================"

      - name: Rename APK with timestamp
        working-directory: .
        run: |
          # Find APK file based on build type
          if [ "${{ inputs.buildType }}" = "release" ]; then
            APK_SOURCE=$(find apps/mobile/android/app/build/outputs/apk/release -name "app-release.apk" | head -1)
          else
            APK_SOURCE=$(find apps/mobile/android/app/build/outputs/apk/debug -name "app-debug.apk" | head -1)
          fi
          
          if [ -z "$APK_SOURCE" ]; then
            echo "âŒ APK file not found!"
            exit 1
          fi
          
          # Create output directory
          mkdir -p output
          
          # Copy and rename with timestamp
          cp "$APK_SOURCE" "output/${{ steps.version.outputs.APK_NAME }}.apk"
          
          echo "âœ… APK renamed to: ${{ steps.version.outputs.APK_NAME }}.apk"
          echo "ðŸ“¦ APK size:"
          ls -lh output/

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: morobooth-v${{ steps.version.outputs.version }}-${{ inputs.buildType }}
          path: output/${{ steps.version.outputs.APK_NAME }}.apk
          retention-days: 30

      - name: Set build status
        id: build_status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=âœ… Build berhasil! APK siap untuk di-download." >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=âŒ Build gagal! Silakan cek logs untuk detail." >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
          fi

    outputs:
      version: ${{ steps.version.outputs.version }}
      apk_name: ${{ steps.version.outputs.APK_NAME }}
      build_status: ${{ steps.build_status.outputs.status }}

  notify:
    name: Send Build Notification
    runs-on: ubuntu-latest
    needs: build-android
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get build info
        id: build_info
        run: |
          BUILD_STATUS="${{ needs.build-android.result }}"
          BUILD_TYPE="${{ inputs.buildType }}"
          VERSION="${{ needs.build-android.outputs.version }}"
          APK_NAME="${{ needs.build-android.outputs.apk_name }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          if [ "$BUILD_STATUS" == "success" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="Berhasil"
            STATUS_COLOR="0x00ff00"
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="Gagal"
            STATUS_COLOR="0xff0000"
          fi
          
          echo "status=$BUILD_STATUS" >> $GITHUB_OUTPUT
          echo "status_emoji=$STATUS_EMOJI" >> $GITHUB_OUTPUT
          echo "status_text=$STATUS_TEXT" >> $GITHUB_OUTPUT
          echo "status_color=$STATUS_COLOR" >> $GITHUB_OUTPUT
          echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "run_url=$RUN_URL" >> $GITHUB_OUTPUT

      # Discord Notification
      - name: Send Discord Notification
        if: ${{ secrets.DISCORD_WEBHOOK_URL != '' }}
        run: |
          MESSAGE="**${{ steps.build_info.outputs.status_emoji }} Build Android APK ${{ steps.build_info.outputs.status_text }}**
          
          **Build Details:**
          - Build Type: \`${{ steps.build_info.outputs.build_type }}\`
          - Version: \`v${{ steps.build_info.outputs.version }}\`
          - APK: \`${{ steps.build_info.outputs.apk_name }}.apk\`
          - Status: **${{ steps.build_info.outputs.status_text }}**
          
          **Links:**
          - [View Workflow Run](${{ steps.build_info.outputs.run_url }})
          - [Download Artifacts](${{ steps.build_info.outputs.run_url }})
          
          _Build completed at $(date -u +'%Y-%m-%d %H:%M:%S UTC')_"
          
          curl -H "Content-Type: application/json" \
            -d "{\"content\": \"$MESSAGE\"}" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      # Slack Notification
      - name: Send Slack Notification
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        run: |
          cat > /tmp/slack_message.json << EOF
          {
            "text": "${{ steps.build_info.outputs.status_emoji }} Android APK Build ${{ steps.build_info.outputs.status_text }}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${{ steps.build_info.outputs.status_emoji }} Build ${{ steps.build_info.outputs.status_text }}"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Build Type:*\n\`${{ steps.build_info.outputs.build_type }}\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Version:*\n\`v${{ steps.build_info.outputs.version }}\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Status:*\n*${{ steps.build_info.outputs.status_text }}*"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*APK:*\n\`${{ steps.build_info.outputs.apk_name }}.apk\`"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "<${{ steps.build_info.outputs.run_url }}|View Workflow Run> | <${{ steps.build_info.outputs.run_url }}|Download Artifacts>"
                }
              }
            ]
          }
          EOF
          
          curl -X POST -H 'Content-type: application/json' \
            --data @/tmp/slack_message.json \
            "${{ secrets.SLACK_WEBHOOK_URL }}"

      # Telegram Notification
      - name: Send Telegram Notification
        if: ${{ secrets.TELEGRAM_BOT_TOKEN != '' && secrets.TELEGRAM_CHAT_ID != '' }}
        run: |
          MESSAGE="*${{ steps.build_info.outputs.status_emoji }} Build Android APK ${{ steps.build_info.outputs.status_text }}*
          
          *Build Details:*
          â€¢ Build Type: \`${{ steps.build_info.outputs.build_type }}\`
          â€¢ Version: \`v${{ steps.build_info.outputs.version }}\`
          â€¢ APK: \`${{ steps.build_info.outputs.apk_name }}.apk\`
          â€¢ Status: *${{ steps.build_info.outputs.status_text }}*
          
          *Links:*
          â€¢ [View Workflow](${{ steps.build_info.outputs.run_url }})
          â€¢ [Download APK](${{ steps.build_info.outputs.run_url }})
          
          _$(date -u +'%Y-%m-%d %H:%M:%S UTC')_"
          
          curl -s -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$(echo "$MESSAGE" | sed 's/"/\\"/g')" \
            -d "parse_mode=Markdown" \
            -d "disable_web_page_preview=false"

      # Email Notification via GitHub API (using repository dispatch or simple curl to email service)
      - name: Send Email Notification (via SMTP)
        if: ${{ secrets.SMTP_HOST != '' && secrets.EMAIL_TO != '' }}
        run: |
          echo "Email notification would be sent to ${{ secrets.EMAIL_TO }}"
          # This requires a custom email action or service
          # You can use actions like 'dawidd6/action-send-mail@v3'

      # GitHub Status Comment (posts a comment on the commit if it's a PR)
      - name: Comment Build Status
        if: ${{ github.event_name == 'pull_request' && github.token != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.build_info.outputs.status_text }}';
            const emoji = '${{ steps.build_info.outputs.status_emoji }}';
            const buildType = '${{ steps.build_info.outputs.build_type }}';
            const version = '${{ steps.build_info.outputs.version }}';
            const apkName = '${{ steps.build_info.outputs.apk_name }}';
            const runUrl = '${{ steps.build_info.outputs.run_url }}';
            
            const comment = `## ${emoji} Android APK Build ${status}
            
            **Build Information:**
            - Build Type: \`${buildType}\`
            - Version: \`v${version}\`
            - APK: \`${apkName}.apk\`
            - Status: **${status}**
            
            [View Workflow Run](${runUrl}) | [Download Artifacts](${runUrl})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      # Final status notification
      - name: Build Completion Summary
        run: |
          echo "=========================================="
          echo "${{ steps.build_info.outputs.status_emoji }} Build Notification Sent"
          echo "=========================================="
          echo "Status: ${{ steps.build_info.outputs.status_text }}"
          echo "Build Type: ${{ steps.build_info.outputs.build_type }}"
          echo "Version: v${{ steps.build_info.outputs.version }}"
          echo "APK: ${{ steps.build_info.outputs.apk_name }}.apk"
          echo "Workflow URL: ${{ steps.build_info.outputs.run_url }}"
          echo "=========================================="

