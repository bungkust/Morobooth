name: Supabase Keep Alive

on:
  schedule:
    # Jalankan setiap hari jam 00:00 UTC (07:00 WIB)
    - cron: '0 0 * * *'
  workflow_dispatch: # Untuk manual trigger dari GitHub UI

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    
    steps:
      - name: Keep Supabase Database Alive
        run: |
          echo "üîÑ Starting Supabase health check..."
          
          # Validasi environment variables
          if [ -z "$SUPABASE_URL" ] || [ "$SUPABASE_URL" = "" ]; then
            echo "‚ùå Error: SUPABASE_URL is not set"
            echo "Please set SUPABASE_URL or VITE_SUPABASE_URL in GitHub Secrets"
            exit 1
          fi
          
          if [ -z "$SUPABASE_ANON_KEY" ] || [ "$SUPABASE_ANON_KEY" = "" ]; then
            echo "‚ùå Error: SUPABASE_ANON_KEY is not set"
            echo "Please set SUPABASE_ANON_KEY or VITE_SUPABASE_ANON_KEY in GitHub Secrets"
            exit 1
          fi
          
          echo "‚úÖ Environment variables validated"
          # Show URL prefix only (safe substring)
          URL_PREFIX=$(echo "$SUPABASE_URL" | cut -c1-30)
          echo "Supabase URL: ${URL_PREFIX}..."
          
          # Health check dengan query sederhana ke tabel sessions
          # Menggunakan format yang lebih reliable dengan error handling
          set +e  # Don't exit on error for curl
          
          # Buat request ke Supabase
          # Query sederhana ke tabel sessions untuk keep-alive
          curl -s -o /tmp/response.txt -w "%{http_code}" \
            -X GET \
            "${SUPABASE_URL}/rest/v1/sessions?select=id&limit=1" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            -H "Content-Type: application/json" \
            > /tmp/http_code.txt 2>/tmp/curl_error.txt
          
          CURL_EXIT=$?
          HTTP_CODE=$(cat /tmp/http_code.txt 2>/dev/null | tr -d '\n' || echo "000")
          BODY=$(cat /tmp/response.txt 2>/dev/null || echo "")
          CURL_ERROR=$(cat /tmp/curl_error.txt 2>/dev/null || echo "")
          
          echo "HTTP Status Code: $HTTP_CODE"
          if [ -n "$BODY" ]; then
            echo "Response preview: ${BODY:0:200}"
          fi
          if [ -n "$CURL_ERROR" ]; then
            echo "Curl stderr: $CURL_ERROR"
          fi
          
          set -e  # Re-enable exit on error
          
          # Untuk keep-alive, yang penting adalah ada aktivitas ke database
          # Jadi kita anggap sukses selama ada request (meskipun error)
          if [ "$CURL_EXIT" -eq 0 ] && { [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "206" ]; }; then
            echo "‚úÖ Health check berhasil! Database aktif."
            exit 0
          elif [ "$CURL_EXIT" -eq 0 ]; then
            echo "‚ö†Ô∏è Warning: Health check returned status $HTTP_CODE"
            echo "‚úÖ But keep-alive purpose achieved - database was accessed"
            exit 0
          else
            echo "‚ö†Ô∏è Warning: curl command failed with exit code $CURL_EXIT"
            echo "‚ö†Ô∏è This might indicate a configuration issue"
            echo "Please check your SUPABASE_URL and SUPABASE_ANON_KEY secrets"
            # Exit 0 untuk keep-alive, tapi log warning
            exit 0
          fi
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL || secrets.VITE_SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || secrets.VITE_SUPABASE_ANON_KEY }}

